---
export const prerender = false;

import { ApolloClient, InMemoryCache, HttpLink, gql } from "@apollo/client/core";
import StoreLayout from "../../layouts/StoreLayout.astro";
import { QUERY_PRODUCT_BY_SLUG } from "../../lib/gql";

// Forward the browser cookie to Vendure during SSR (for consistent session)
const cookieHeader = Astro.request.headers.get('cookie') ?? '';

const client = new ApolloClient({
  link: new HttpLink({
    uri: import.meta.env.PUBLIC_SHOP_API_URL,
    fetch: (uri, options) => {
      const headers = new Headers(options?.headers || {});
      if (cookieHeader) headers.set('cookie', cookieHeader);
      return fetch(uri, { ...options, headers });
    },
  }),
  cache: new InMemoryCache(),
});

const slug = Astro.params.slug!;
const { data } = await client.query({
  query: gql(QUERY_PRODUCT_BY_SLUG),
  variables: { slug },
  fetchPolicy: "no-cache",
});
const product = data?.product ?? null;
const firstVariantId = product?.variants?.[0]?.id ?? null;
const price = product?.variants?.[0]?.priceWithTax ?? null;
const currencyCode = product?.variants?.[0]?.currencyCode ?? "";
---

<StoreLayout title={product ? product.name : 'Product'}>
  {!product ? (
    <p>Not found.</p>
  ) : (
    <>
      <section style="display:grid; grid-template-columns: 1fr 1fr; gap: 1.25rem; align-items:start;">
        <div style="border:1px solid #eee; border-radius:12px; padding:1rem; background:#fff; min-height:320px; display:flex; align-items:center; justify-content:center;">
          {product.featuredAsset?.preview ? (
            <img src={product.featuredAsset.preview} alt={product.name} style="max-width:100%; max-height:420px; object-fit:contain;" loading="lazy" />
          ) : (
            <div style="color:#777">No image</div>
          )}
        </div>
        <div>
          <h1 style="margin-top:0;">{product.name}</h1>
          {price !== null ? (
            <div style="color:#555; margin-bottom: .5rem;">
              {(price/100).toFixed(2)} {currencyCode}
            </div>
          ) : null}
          <div style="color:#555; white-space:pre-wrap; margin: .5rem 0 1rem 0;">{product.description}</div>

          {firstVariantId ? (
            // Pure HTML form (no JS). The server will 302 â†’ /cart and set the cookie with Path=/
            <form method="post" action={`/api/cart/add?variantId=${encodeURIComponent(firstVariantId)}&quantity=1`} style="display:flex; gap:.5rem; align-items:center;">
              <input type="hidden" name="variantId" value={firstVariantId} />
              <input name="quantity" type="number" value="1" min="1" style="width:80px; padding:.5rem; border:1px solid #ddd; border-radius:8px;" />
              <button type="submit" style="padding:.65rem 1rem; border-radius:10px; background:black; color:white; border:none; cursor:pointer;">
                Add to cart
              </button>
            </form>
          ) : (
            <div style="color:#a00">No purchasable variants.</div>
          )}
        </div>
      </section>
    </>
  )}
</StoreLayout>
