---
export const prerender = false;

import { ApolloClient, InMemoryCache, gql, HttpLink } from "@apollo/client/core";
import StoreLayout from "../layouts/StoreLayout.astro";
import Hero from "../components/Hero.astro";
import ProductCard from "../components/ProductCard.astro";

const client = new ApolloClient({
  link: new HttpLink({
    uri: import.meta.env.PUBLIC_SHOP_API_URL,
    fetch,
    fetchOptions: { credentials: "include" },
  }),
  cache: new InMemoryCache(),
});

const { data } = await client.query({
  query: gql`
    query HomeProducts {
      products(options: { take: 24 }) {
        items {
          id
          slug
          name
          featuredAsset { preview }
          variants {
            id
            name
            priceWithTax
            currencyCode
          }
        }
        totalItems
      }
    }
  `,
  fetchPolicy: "no-cache",
});

const items = data?.products?.items ?? [];
const total = data?.products?.totalItems ?? 0;
---

<StoreLayout title="Ventio â€” Marketplace" description="A new and improved way to find the right buyers and sell in Cyprus.">
  <Hero />

  <section id="products" style="scroll-margin-top: 80px;">
    <h2 style="margin: 0 0 .25rem 0;">Products</h2>
    <p style="color:#666; margin-top:0;">{total} item{total === 1 ? '' : 's'}</p>

    {items.length === 0 ? (
      <p>No products yet.</p>
    ) : (
      <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1rem;">
        {items.map((p:any) => <ProductCard product={p} />)}
      </div>
    )}
  </section>
</StoreLayout>
